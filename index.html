<!DOCTYPE html><html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FOLIO OCR ‚Üí QR (Plan B: Foto)</title>
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;background:var(--bg);color:#e5e7eb}
    header{padding:16px;border-bottom:1px solid #1f2937;background:#0b1220}
    h1{font-size:18px;margin:0} .sub{font-size:12px;color:var(--muted)}
    main{max-width:960px;margin:0 auto;padding:16px;display:grid;gap:14px}
    .card{background:#111827;border:1px solid #1f2937;border-radius:16px;padding:14px}
    .stack{display:grid;gap:10px}
    .controls{display:flex;flex-wrap:wrap;gap:8px}
    button, .btn{appearance:none;border:1px solid #334155;background:#0b1220;color:#e5e7eb;padding:10px 14px;border-radius:12px;cursor:pointer}
    button:hover{border-color:#475569}
    input[type=text]{width:100%;padding:12px 14px;border:1px solid #334155;border-radius:12px;background:#0b1220;color:#e5e7eb;font-size:16px}
    .status{font-size:13px;color:var(--muted)}
    #preview{width:100%;border-radius:16px;background:#000;max-height:50vh;object-fit:contain}
    #qrcode{display:grid;place-items:center;background:#0b1220;border:1px dashed #334155;border-radius:16px;min-height:260px}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid #334155;border-radius:999px;font-size:12px;cursor:pointer}
    .pill:hover{border-color:#64748b}
    .muted{color:var(--muted)}
    .small{font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>OCR ‚Üí QR para folios</h1>
    <div class=\"sub\">Plan B: sin permisos de c√°mara. Toma/elige una <strong>foto</strong> del cup√≥n, detecta el folio y genera el QR. <em>Forzando longitud 16 con correcciones O‚Üî0, I‚Üî1, B‚Üî8.</em></div>
  </header>  <main>
    <section class="card stack">
      <div class="controls">
        <label for="fileInput" class="btn">üì∑ Tomar foto / Elegir imagen</label>
        <input id="fileInput" type="file" accept="image/*" capture="environment" hidden>
        <button id="rephoto">üîÅ Tomar otra</button>
        <button id="tryAgain">üîç Analizar de nuevo</button>
      </div>
      <img id="preview" alt="Vista previa" />
      <canvas id="work" hidden></canvas>
      <div id="status" class="status">Listo. Sube una foto n√≠tida y bien iluminada del folio.</div><div class="stack">
    <label class="small muted">Folio detectado (puedes corregirlo):</label>
    <input id="folio" type="text" placeholder="Ej. FQ656CVFB4LD4Y88" />
    <div class="controls">
      <button id="makeQR">‚úÖ Generar QR</button>
      <button id="copyFolio">üìã Copiar folio</button>
      <button id="clear">‚ôªÔ∏è Limpiar</button>
    </div>
    <div class="small muted">Sugerencias detectadas:</div>
    <div id="candidates" class="controls"></div>
  </div>
</section>

<section class="card stack">
  <div class="small muted">C√≥digo QR</div>
  <div id="qrcode"></div>
  <div class="small muted">Consejos: evita sombras, acerca el cup√≥n y mant√©n la foto paralela al papel. Si falla, intenta otra toma.</div>
</section>

  </main>  <!-- Librer√≠as -->  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>  <script>
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const work = document.getElementById('work');
    const statusEl = document.getElementById('status');
    const folioInput = document.getElementById('folio');
    const candidatesEl = document.getElementById('candidates');
    const qrcodeEl = document.getElementById('qrcode');

    let worker = null;
    function setStatus(msg){ statusEl.textContent = msg; }

    async function initOCR(){
      if(worker) return;
      setStatus('Cargando OCR‚Ä¶');
      worker = await Tesseract.createWorker({ logger: m => {
        if(m.status && m.progress!=null){ setStatus(`${m.status} ${(m.progress*100).toFixed(0)}%`); }
      }});
      await worker.loadLanguage('eng');
      await worker.initialize('eng');
      await worker.setParameters({ tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789' });
      setStatus('OCR listo. Sube una foto.');
    }

    function preprocess(ctx, w, h){
      const img = ctx.getImageData(0,0,w,h);
      const d = img.data;
      // Escala a grises + contraste suave
      const contrast = 1.35, brightness = -10; // ajustables
      for(let i=0;i<d.length;i+=4){
        const r=d[i], g=d[i+1], b=d[i+2];
        let y = 0.299*r + 0.587*g + 0.114*b; // gris
        y = (y-128)*contrast + 128 + brightness; // contraste/ brillo
        y = Math.max(0, Math.min(255, y));
        d[i]=d[i+1]=d[i+2]=y;
      }
      ctx.putImageData(img,0,0);
    }

    function pickCodes(text){
      // Genera variantes para corregir confusiones comunes O‚Üî0, I‚Üî1, B‚Üî8
      function genVariants(s){
        const pairs = [['O','0'],['0','O'],['I','1'],['1','I'],['B','8'],['8','B']];
        const out = new Set();
        for(const [a,b] of pairs){ if(s.includes(a)) out.add(s.split(a).join(b)); }
        return [...out];
      }
      const up = (text||'').toUpperCase().replace(/[^A-Z0-9]/g,' ');
      const tokens = up.split(' ').filter(Boolean);
      const exact16 = tokens.filter(t=>t.length===16);
      const flex = tokens.filter(t=>t.length>=12 && t.length<=20);
      const pool = exact16.length ? exact16 : flex;
      const merged = []; const seen = new Set();
      for(const code of pool){
        if(!seen.has(code)){ merged.push(code); seen.add(code); }
        for(const v of genVariants(code)) if(!seen.has(v)){ merged.push(v); seen.add(v); }
      }
      merged.sort((a,b)=>Math.abs(16-a.length)-Math.abs(16-b.length));
      return {best: merged[0] || null, all: merged.slice(0,10)};
    }\b/g)||[];
      const uniq = [...new Set(m)];
      uniq.sort((a,b)=>Math.abs(16-a.length)-Math.abs(16-b.length));
      return {best: uniq[0]||null, all: uniq.slice(0,8)};
    }

    function renderCandidates(list){
      candidatesEl.innerHTML='';
      list.forEach(code=>{
        const pill=document.createElement('div'); pill.className='pill'; pill.textContent=code;
        pill.onclick=()=>{ folioInput.value=code; makeQR(); };
        candidatesEl.appendChild(pill);
      });
    }

    async function analyze(img){
      await initOCR();
      const w = Math.min(1600, img.naturalWidth);
      const scale = w / img.naturalWidth;
      const h = Math.round(img.naturalHeight * scale);
      work.width = w; work.height = h;
      const ctx = work.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);

      // Dos pasadas: normal y con preproceso
      const out1 = await worker.recognize(work);
      preprocess(ctx, w, h);
      const out2 = await worker.recognize(work);

      const a = pickCodes(out1.data.text), b = pickCodes(out2.data.text);
      const merged = [...new Set([...(a.all||[]), ...(b.all||[])])];
      merged.sort((x,y)=>Math.abs(16-x.length)-Math.abs(16-y.length));
      renderCandidates(merged);
      if(merged[0]){ folioInput.value = merged[0]; makeQR(); setStatus('Folio detectado.'); }
      else setStatus('No se detect√≥ un folio claro. Intenta otra foto.');
    }

    fileInput.addEventListener('change', ()=>{
      const file = fileInput.files[0]; if(!file) return;
      const img = new Image();
      img.onload = ()=>{ preview.src = img.src; analyze(img); };
      img.src = URL.createObjectURL(file);
    });

    document.getElementById('rephoto').onclick = ()=> fileInput.click();
    document.getElementById('tryAgain').onclick = ()=>{ if(preview.src) { const img=new Image(); img.onload=()=>analyze(img); img.src=preview.src; } };

    function makeQR(){
      const t=(folioInput.value||'').trim().toUpperCase();
      if(!t) return;
      if(t.length!==16){ setStatus('Aviso: el folio no tiene 16 caracteres. Revisa O/0, I/1, B/8.'); }
      qrcodeEl.innerHTML='';
      new QRCode(qrcodeEl,{ text:t, width:300, height:300, correctLevel:QRCode.CorrectLevel.M });
    });
    }
    document.getElementById('makeQR').onclick = makeQR;
    document.getElementById('copyFolio').onclick = async ()=>{
      try{ await navigator.clipboard.writeText((folioInput.value||'').trim()); setStatus('Folio copiado.'); }catch(e){ setStatus('No se pudo copiar.'); }
    };
    document.getElementById('clear').onclick = ()=>{ folioInput.value=''; qrcodeEl.innerHTML=''; candidatesEl.innerHTML=''; setStatus('Listo. Sube otra foto.'); };

    // inicio
    setStatus('Listo. Sube una foto n√≠tida y bien iluminada del folio.');
  </script></body>
</html>
